@model KosovaDoganaModerne.Modelet.Entitetet.FormatPrintimi

@{
    ViewData["Title"] = "Editimi i formatit të printimit";
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-edit"></i> Editimi i formatit të printimit</h2>
        <a asp-action="PrintFormats" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Kthehu
        </a>
    </div>

    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> 
        <strong>Udhëzim:</strong> Përdorni editorin vizual për të krijuar formatintuaj të printimit. 
        Nuk nevojitet njohuri e HTML ose CSS!
    </div>

    <div class="row">
        <!-- Left Panel - Visual Editor -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> Editori Vizual</h5>
                </div>
                <div class="card-body">
                    <form id="visualEditorForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Emri i formatit *</label>
                            <input type="text" class="form-control" id="formatName" required placeholder="p.sh. Raport Standard A4" />
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Lloji i modulit *</label>
                                <select class="form-control" id="moduleType" required>
                                    <option value="">-- Zgjidhni --</option>
                                    <option value="VleratProdukteve">Vlerat e produkteve</option>
                                    <option value="KomentetDegeve">Komentet e degëve</option>
                                    <option value="ShpenzimetTransportit">Shpenzimet e transportit</option>
                                    <option value="Raportet">Raportet</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Madhësia e letrës</label>
                                <select class="form-control" id="paperSize">
                                    <option value="A4" selected>A4 (210 x 297 mm)</option>
                                    <option value="A5">A5 (148 x 210 mm)</option>
                                    <option value="Letter">Letter (216 x 279 mm)</option>
                                    <option value="Legal">Legal (216 x 356 mm)</option>
                                </select>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Header Section -->
                        <div class="mb-4">
                            <h5 class="text-primary"><i class="fas fa-heading"></i> Koka e dokumentit (Header)</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Logo</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="logoUrl" placeholder="/images/logo.png" />
                                        <small class="text-muted">URL e logos së organizatës</small>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-control" id="logoPosition">
                                            <option value="center">Qendër</option>
                                            <option value="left">Majtas</option>
                                            <option value="right">Djathtas</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Titulli kryesor</label>
                                <input type="text" class="form-control" id="headerTitle" placeholder="REPUBLIKA E KOSOVËS - DOGANA" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nëntitulli</label>
                                <input type="text" class="form-control" id="headerSubtitle" placeholder="Administrata e Doganave" />
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Madhësia e shkronjave (Titulli)</label>
                                    <select class="form-control" id="headerTitleSize">
                                        <option value="18">18pt - Vogël</option>
                                        <option value="22" selected>22pt - Normale</option>
                                        <option value="26">26pt - Mesatare</option>
                                        <option value="30">30pt - E madhe</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ngjyra e tekstit</label>
                                    <select class="form-control" id="headerColor">
                                        <option value="#000000" selected>E zezë</option>
                                        <option value="#0d6efd">Blu</option>
                                        <option value="#198754">Jeshile</option>
                                        <option value="#dc3545">E kuqe</option>
                                        <option value="#6c757d">Gri</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Content Section -->
                        <div class="mb-4">
                            <h5 class="text-primary"><i class="fas fa-align-left"></i> Përmbajtja e dokumentit</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Të dhënat për t'u shfaqur</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showDate" checked />
                                    <label class="form-check-label" for="showDate">Shfaq datën dhe orën</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showUser" checked />
                                    <label class="form-check-label" for="showUser">Shfaq përdoruesin</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showPageNumber" checked />
                                    <label class="form-check-label" for="showPageNumber">Shfaq numrin e faqes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showBorders" />
                                    <label class="form-check-label" for="showBorders">Shfaq kufijtë e tabelës</label>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Madhësia e shkronjave (Përmbajtje)</label>
                                    <select class="form-control" id="contentFontSize">
                                        <option value="10">10pt - Vogël</option>
                                        <option value="12" selected>12pt - Normale</option>
                                        <option value="14">14pt - Mesatare</option>
                                        <option value="16">16pt - E madhe</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Stili i tabelës</label>
                                    <select class="form-control" id="tableStyle">
                                        <option value="striped" selected>Me shirita (alternativ)</option>
                                        <option value="bordered">Me kufi</option>
                                        <option value="hover">Me hover efekt</option>
                                        <option value="compact">Kompakt</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <!-- Footer Section -->
                        <div class="mb-4">
                            <h5 class="text-primary"><i class="fas fa-shoe-prints"></i> Fundi i dokumentit (Footer)</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Teksti i fundit</label>
                                <textarea class="form-control" id="footerText" rows="2" placeholder="Adresa: Prishtinë, Kosovë | Tel: +383 xx xxx xxx"></textarea>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showFooterLine" checked />
                                <label class="form-check-label" for="showFooterLine">Shfaq vijën ndarëse</label>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isDefault" />
                            <label class="form-check-label fw-bold" for="isDefault">
                                <i class="fas fa-star"></i> Vendos si format default për këtë modul
                            </label>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-info" onclick="previewFormat()">
                                <i class="fas fa-eye"></i> Pamja paraprake
                            </button>
                            <button type="button" class="btn btn-success" onclick="generateAndSave()">
                                <i class="fas fa-save"></i> Ruaj formatin
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Rivendos
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Panel - Live Preview -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-eye"></i> Pamja e drejtpërdrejtë</h5>
                </div>
                <div class="card-body">
                    <div id="livePreview" class="border p-3 bg-white" style="min-height: 400px; overflow-y: auto; max-height: 600px;">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p>Përditësohet automatikisht...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-update preview on any change
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('change', updateLivePreview);
            element.addEventListener('keyup', updateLivePreview);
        });

        function updateLivePreview() {
            const preview = generatePreview();
            document.getElementById('livePreview').innerHTML = preview;
        }

        function generatePreview() {
            const formatName = document.getElementById('formatName').value || 'Format i ri';
            const logoUrl = document.getElementById('logoUrl').value;
            const logoPosition = document.getElementById('logoPosition').value;
            const headerTitle = document.getElementById('headerTitle').value || 'REPUBLIKA E KOSOVËS';
            const headerSubtitle = document.getElementById('headerSubtitle').value || 'Administrata e Doganave';
            const headerTitleSize = document.getElementById('headerTitleSize').value;
            const headerColor = document.getElementById('headerColor').value;
            const contentFontSize = document.getElementById('contentFontSize').value;
            const showDate = document.getElementById('showDate').checked;
            const showUser = document.getElementById('showUser').checked;
            const showBorders = document.getElementById('showBorders').checked;
            const tableStyle = document.getElementById('tableStyle').value;
            const footerText = document.getElementById('footerText').value;
            const showFooterLine = document.getElementById('showFooterLine').checked;

            let html = '<div style="font-size: ' + contentFontSize + 'pt; font-family: Arial, sans-serif;">';
            
            // Header
            html += '<div style="text-align: ' + logoPosition + '; margin-bottom: 20px;">';
            if (logoUrl) {
                html += '<img src="' + logoUrl + '" style="max-width: 150px; max-height: 80px;" />';
            }
            html += '<div style="font-size: ' + headerTitleSize + 'pt; font-weight: bold; color: ' + headerColor + '; margin-top: 10px;">' + headerTitle + '</div>';
            html += '<div style="font-size: ' + (parseInt(headerTitleSize) - 4) + 'pt; color: #666; margin-top: 5px;">' + headerSubtitle + '</div>';
            html += '</div>';

            html += '<hr style="border: 1px solid #ddd; margin: 20px 0;" />';

            // Info section
            html += '<div style="margin-bottom: 15px;">';
            if (showDate) {
                html += '<div><strong>Data:</strong> ' + new Date().toLocaleDateString('sq-AL') + ' ' + new Date().toLocaleTimeString('sq-AL') + '</div>';
            }
            if (showUser) {
                html += '<div><strong>Përdoruesi:</strong> ' + (document.querySelector('user-name')?.textContent || 'Shembull Përdorues') + '</div>';
            }
            html += '</div>';

            // Sample table
            let tableClass = 'width: 100%; border-collapse: collapse; margin-top: 20px;';
            let cellStyle = showBorders ? 'border: 1px solid #ddd; padding: 8px;' : 'padding: 8px;';
            let headerCellStyle = cellStyle + ' background-color: #f8f9fa; font-weight: bold;';
            
            html += '<table style="' + tableClass + '">';
            html += '<thead><tr>';
            html += '<th style="' + headerCellStyle + '">#</th>';
            html += '<th style="' + headerCellStyle + '">Kodi</th>';
            html += '<th style="' + headerCellStyle + '">Përshkrimi</th>';
            html += '<th style="' + headerCellStyle + '">Vlera</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            let rowStyle = cellStyle;
            if (tableStyle === 'striped') {
                for (let i = 1; i <= 3; i++) {
                    let bgColor = i % 2 === 0 ? 'background-color: #f8f9fa;' : '';
                    html += '<tr style="' + bgColor + '">';
                    html += '<td style="' + cellStyle + '">' + i + '</td>';
                    html += '<td style="' + cellStyle + '">PROD-' + (100 + i) + '</td>';
                    html += '<td style="' + cellStyle + '">Shembull produkti ' + i + '</td>';
                    html += '<td style="' + cellStyle + '">€ ' + (i * 10) + '.00</td>';
                    html += '</tr>';
                }
            } else {
                for (let i = 1; i <= 3; i++) {
                    html += '<tr>';
                    html += '<td style="' + cellStyle + '">' + i + '</td>';
                    html += '<td style="' + cellStyle + '">PROD-' + (100 + i) + '</td>';
                    html += '<td style="' + cellStyle + '">Shembull produkti ' + i + '</td>';
                    html += '<td style="' + cellStyle + '">€ ' + (i * 10) + '.00</td>';
                    html += '</tr>';
                }
            }
            
            html += '</tbody></table>';

            // Footer
            if (showFooterLine) {
                html += '<hr style="border: 1px solid #ddd; margin: 20px 0;" />';
            }
            if (footerText) {
                html += '<div style="text-align: center; font-size: ' + (parseInt(contentFontSize) - 2) + 'pt; color: #666; margin-top: 15px;">' + footerText + '</div>';
            }

            html += '</div>';
            return html;
        }

        function generateHTML() {
            const logoUrl = document.getElementById('logoUrl').value;
            const logoPosition = document.getElementById('logoPosition').value;
            const headerTitle = document.getElementById('headerTitle').value || 'REPUBLIKA E KOSOVËS';
            const headerSubtitle = document.getElementById('headerSubtitle').value || 'Administrata e Doganave';
            const headerTitleSize = document.getElementById('headerTitleSize').value;
            const headerColor = document.getElementById('headerColor').value;
            const contentFontSize = document.getElementById('contentFontSize').value;
            const showDate = document.getElementById('showDate').checked;
            const showUser = document.getElementById('showUser').checked;
            const showPageNumber = document.getElementById('showPageNumber').checked;
            const showBorders = document.getElementById('showBorders').checked;
            const footerText = document.getElementById('footerText').value;
            const showFooterLine = document.getElementById('showFooterLine').checked;

            let html = '<div class="print-document">';
            html += '<div class="print-header" style="text-align: ' + logoPosition + ';">';
            if (logoUrl) {
                html += '<img src="' + logoUrl + '" class="print-logo" />';
            }
            html += '<h1 class="print-title">' + headerTitle + '</h1>';
            html += '<h2 class="print-subtitle">' + headerSubtitle + '</h2>';
            html += '</div>';
            html += '<hr class="print-divider" />';
            html += '<div class="print-info">';
            if (showDate) html += '<div><strong>Data:</strong> {{date}}</div>';
            if (showUser) html += '<div><strong>Përdoruesi:</strong> {{user}}</div>';
            html += '</div>';
            html += '<div class="print-content">{{content}}</div>';
            if (showFooterLine) html += '<hr class="print-divider" />';
            if (footerText) html += '<div class="print-footer">' + footerText + '</div>';
            if (showPageNumber) html += '<div class="print-page-number">Faqja {{pageNumber}}</div>';
            html += '</div>';

            return html;
        }

        function generateCSS() {
            const headerTitleSize = document.getElementById('headerTitleSize').value;
            const headerColor = document.getElementById('headerColor').value;
            const contentFontSize = document.getElementById('contentFontSize').value;
            const showBorders = document.getElementById('showBorders').checked;
            const tableStyle = document.getElementById('tableStyle').value;

            let css = '.print-document { font-family: Arial, sans-serif; font-size: ' + contentFontSize + 'pt; }\\n';
            css += '.print-header { margin-bottom: 20px; }\\n';
            css += '.print-logo { max-width: 150px; max-height: 80px; }\\n';
            css += '.print-title { font-size: ' + headerTitleSize + 'pt; color: ' + headerColor + '; font-weight: bold; margin: 10px 0; }\\n';
            css += '.print-subtitle { font-size: ' + (parseInt(headerTitleSize) - 4) + 'pt; color: #666; margin: 5px 0; }\\n';
            css += '.print-divider { border: 1px solid #ddd; margin: 20px 0; }\\n';
            css += '.print-info { margin-bottom: 15px; }\\n';
            css += '.print-content table { width: 100%; border-collapse: collapse; margin-top: 20px; }\\n';
            css += '.print-content th, .print-content td { padding: 8px; ' + (showBorders ? 'border: 1px solid #ddd;' : '') + ' }\\n';
            css += '.print-content th { background-color: #f8f9fa; font-weight: bold; }\\n';
            
            if (tableStyle === 'striped') {
                css += '.print-content tr:nth-child(even) { background-color: #f8f9fa; }\\n';
            }
            
            css += '.print-footer { text-align: center; font-size: ' + (parseInt(contentFontSize) - 2) + 'pt; color: #666; margin-top: 15px; }\\n';
            css += '.print-page-number { text-align: center; margin-top: 10px; }\\n';
            css += '@@media print { @@page { size: ' + document.getElementById('paperSize').value + '; } }';

            return css;
        }

        function generateAndSave() {
            const formatName = document.getElementById('formatName').value;
            const moduleType = document.getElementById('moduleType').value;
            const paperSize = document.getElementById('paperSize').value;
            const isDefault = document.getElementById('isDefault').checked;

            if (!formatName || !moduleType) {
                alert('Emri i formatit dhe lloji i modulit janë të detyrueshëm!');
                return;
            }

            const html = generateHTML();
            const css = generateCSS();
            const logoUrl = document.getElementById('logoUrl').value;
            const logoPosition = document.getElementById('logoPosition').value;

            const data = {
                EmriFormatit: formatName,
                LlojiModulit: moduleType,
                HtmlTemplate: html,
                CssStyle: css,
                LogoUrl: logoUrl,
                LogoPosition: logoPosition,
                PaperSize: paperSize,
                EshteDefault: isDefault
            };

            fetch('/Admin/SavePrintFormat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Formati u ruajt me sukses!');
                    window.location.href = '/Admin/PrintFormats';
                } else {
                    alert('Gabim: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Gabim gjatë ruajtjes. Ju lutem provoni përsëri.');
            });
        }

        function previewFormat() {
            const preview = generatePreview();
            const previewWindow = window.open('', 'Preview', 'width=900,height=700');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Pamja paraprake - ${document.getElementById('formatName').value || 'Format i ri'}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; background: #f5f5f5; }
                        .preview-container { background: white; padding: 40px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 210mm; margin: 0 auto; }
                        @@media print { 
                            body { background: white; }
                            .preview-container { box-shadow: none; padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="preview-container">
                        ${preview}
                    </div>
                    <div class="text-center mt-3 no-print">
                        <button class="btn btn-primary" onclick="window.print()">
                            <i class="fas fa-print"></i> Printo
                        </button>
                        <button class="btn btn-secondary" onclick="window.close()">
                            Mbyll
                        </button>
                    </div>
                </body>
                </html>
            `);
            previewWindow.document.close();
        }

        function resetForm() {
            if (confirm('Jeni i sigurt që doni të rivendosni formën?')) {
                document.getElementById('visualEditorForm').reset();
                updateLivePreview();
            }
        }

        // Initialize live preview
        setTimeout(updateLivePreview, 100);
    </script>
}
